import { useMultiFileAuthState, makeWASocket, DisconnectReason } from "@whiskeysockets/baileys";
import axios from "axios";
import qrcode from "qrcode-terminal";

async function startSock() {
  const { state, saveCreds } = await useMultiFileAuthState("auth_info_baileys");

  const sock = makeWASocket({
    auth: state,
  });

  sock.ev.on("connection.update", (update) => {
    const { connection, lastDisconnect, qr } = update;

    if (qr) {
      console.log("ğŸ“± Scan the QR Code:");
      qrcode.generate(qr, { small: true });
    }

    if (connection === "close") {
      const shouldReconnect =
        lastDisconnect?.error?.output?.statusCode !== DisconnectReason.loggedOut;
      console.log("âŒ Disconnected: ", lastDisconnect?.error, " Reconnecting:", shouldReconnect);
      if (shouldReconnect) {
        startSock();
      }
    } else if (connection === "open") {
      console.log("âœ… Connected to WhatsApp");
    }
  });

  sock.ev.on("creds.update", saveCreds);

  sock.ev.on("messages.upsert", async ({ messages, type }) => {
    if (type !== "notify") return;
    const msg = messages[0];
    if (!msg.message || msg.key.fromMe) return;

    const sender = msg.key.remoteJid;
    const text =
      msg.message.conversation || msg.message.extendedTextMessage?.text;

    console.log(`ğŸ“© From ${sender}: ${text}`);

    try {
      const res = await axios.post("http://localhost:5001/process", {
        message: text,
      });

      const reply = res.data.reply || "Sorry, couldn't process your message.";
      await sock.sendMessage(sender, { text: reply });
    } catch (err) {
      console.error("âŒ Error communicating with backend:", err.message);
    }
  });
}

startSock();
